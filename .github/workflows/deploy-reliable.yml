name: Deploy to Beget Hosting (Reliable)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        
    - name: Build project
      run: |
        npm run build
        
    - name: Prepare dist folder
      run: |
        echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è..."
        cd ./dist
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤
        tar -czf ../../deploy-files.tar.gz .
        
        echo "‚úÖ –§–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"
        
    - name: Deploy to Beget via FTP (Retry Strategy)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ${{ secrets.FTP_PATH }}/
        # –ù–∞–¥–µ–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/Thumbs.db
          **/cache/*
          **/logs/*
          **/*.log
          **/data_backups/*
          **/temp_archive/*
          **/test-*.php
          **/debug-*.php
          
    - name: Setup .htaccess for hosting
      run: |
        echo "üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .htaccess –¥–ª—è —Ö–æ—Å—Ç–∏–Ω–≥–∞..."
        echo "‚úÖ –§–∞–π–ª .htaccess —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        echo "üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PHP 8.1 –∏ —Å–µ—Å—Å–∏–π –≤–∫–ª—é—á–µ–Ω—ã"
          
    - name: Cleanup
      run: |
        rm -f deploy-files.tar.gz
        echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        
    - name: Deployment Status
      run: |
        echo "üöÄ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üìÖ –í—Ä–µ–º—è: $(date)"
        echo "üåê –°–∞–π—Ç: https://kungur-tochkagg.ru/"
